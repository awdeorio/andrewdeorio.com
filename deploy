#!/bin/bash
# deploy - build and copy andrewdeorio.com source files
#
# Andrew DeOrio <awdeorio@umich.edu>


echo "EXPERIMENTAL -- DO NOT DEPLOY"
exit 1

# Stop on errors and print commands
set -Eeuxo pipefail

# Clean
rm -rf _site/

# Check jekyll files
jekyll doctor

# Build
jekyll build

# Validate HTML
html5validator --root _site/

# Check for bad links
# FIXME check static files for bad links

# Fix permissions
find _site/ -type f -exec chmod 644 {} \;
find _site/ -type d -exec chmod 755 {} \;

# Copy to server
#
# --checksum  Use a checksum instead of file modification time to detect
# changes.  We need this because files may be cleaned and regenerated by
# Jekyll, even if their content remains the same.
# FIXME do a dry run, then ask user
rsync \
  --recursive \
  --verbose \
  --perms \
  --delete \
  --checksum \
  _site/ \
  awdeorio@web.eecs.umich.edu:public_html/

# Check for bad links on live site
OUTPUT_DIR=/tmp/crawl.out
rm -rf ${OUTPUT_DIR}
wget \
  --no-verbose \
  --spider \
  --user-agent "Mozilla/4.0" \
  --recursive \
  --directory-prefix ${OUTPUT_DIR} \
  --level 5 \
  http://andrewdeorio.com/
rm -rf ${OUTPUT_DIR}
