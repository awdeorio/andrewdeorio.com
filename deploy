#!/bin/bash
# deploy - build and copy andrewdeorio.com source files
#
# Andrew DeOrio <awdeorio@umich.edu>


# Stop on errors and print commands
set -Eeuxo pipefail

# Clean
rm -rf _site/

# Check jekyll files
jekyll doctor

# Build
jekyll build

# Validate HTML
html5validator --root _site/

# Check for bad links
linkchecker _site/index.html

# Fix permissions
find _site/ -type f -exec chmod 644 {} \;
find _site/ -type d -exec chmod 755 {} \;

# Copy to server
#
# --checksum  Use a checksum instead of file modification time to detect
# changes.  We need this because files may be cleaned and regenerated by
# Jekyll, even if their content remains the same.
# FIXME do a dry run, then ask user
rsync \
  --recursive \
  --verbose \
  --perms \
  --delete \
  --checksum \
  _site/ \
  awdeorio@web.eecs.umich.edu:public_html/
